name: Mddplayer Release

# å½“æ–°çš„ tag è¢«æ¨é€åˆ° GitHub æ—¶è§¦å‘æ­¤å·¥ä½œæµ
on:
    push:
        tags:
            - 'v*' # åŒ¹é…æ‰€æœ‰ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾ï¼Œä¾‹å¦‚ v1.5.0

env:
    CARGO_TERM_COLOR: always # å¯ç”¨ Cargo ç»ˆç«¯é¢œè‰²è¾“å‡º
    # æ‚¨çš„é¡¹ç›®åç§°ï¼Œç”¨äºæ„å»ºå’Œæ‰“åŒ…çš„å‘½å
    PROJECT_NAME: mddplayer

jobs:
    # ----------------------------------------
    # 1. è·¨å¹³å°æ„å»ºä½œä¸š
    # ----------------------------------------
    build_release:
        name: Build on ${{ matrix.os }} for ${{ matrix.target }}
        # ä½¿ç”¨çŸ©é˜µå®šä¹‰è¦æ„å»ºçš„å¹³å°
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                # å®šä¹‰ç›®æ ‡ OS å’Œå¯¹åº”çš„ Rust Target
                include:
                    # Windows (MSVC)
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      archive_ext: zip
                      bin_name: mddplayer.exe
                      
                    # Linux (GNU)
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                      archive_ext: tar.gz
                      bin_name: mddplayer
                      
                    # macOS (Darwin)
                    - target: x86_64-apple-darwin
                      os: macos-latest
                      archive_ext: zip
                      bin_name: mddplayer
                      
        steps:
            # 1.1 æ£€å‡ºä»£ç 
            - uses: actions/checkout@v4
            
            # 1.2 å®‰è£… Rust å·¥å…·é“¾å’Œç›®æ ‡å¹³å°
            - name: Install Rust ${{ matrix.target }}
              uses: dtolnay/rust-toolchain@master
              with:
                  toolchain: stable
                  target: ${{ matrix.target }}

            # 1.2.5 ğŸ’¡ æ–°å¢ï¼šå®‰è£… Linux ç³»ç»Ÿä¾èµ–
            - name: Install Linux System Dependencies (ALSA)
              if: runner.os == 'Linux'
              shell: bash
              run: |
                  echo "Installing system dependencies for Linux..."
                  sudo apt-get update
                  sudo apt-get install -y libasound2-dev
            
            # 1.2.5 ğŸ’¡ æ–°å¢ï¼šå®‰è£… Windows ç³»ç»Ÿä¾èµ–
            - name: Install Windows Zip Tool
              if: runner.os == 'Windows'
              # å¿…é¡»ä½¿ç”¨ powershell shell æ¥æ‰§è¡Œ choco å‘½ä»¤
              shell: powershell
              run: |
                  # å®‰è£… zip å‘½ä»¤è¡Œå·¥å…·ï¼Œè§£å†³æ‰“åŒ…æ—¶ zip: command not found é”™è¯¯
                  choco install zip -y
            
                  
            # 1.3 ç¼“å­˜ Cargo ä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º
            - name: Cache Cargo dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-cargo-

            # 1.4 æ„å»º Release ç‰ˆæœ¬
            - name: Build project
              run: cargo build --release --target ${{ matrix.target }}
              # winres æ˜¯ build-dependenciesï¼Œä»…åœ¨ Windows ä¸Šè¢«æ¿€æ´»ï¼Œæ— éœ€æ‹…å¿ƒè·¨å¹³å°é—®é¢˜

            # 1.5 å‡†å¤‡æ‰“åŒ…çš„åç§°å’Œè·¯å¾„
            - name: Set archive variables
              id: archive_vars
              shell: bash
              run: |
                  # æå– Tag åç§° (ä¾‹å¦‚ v1.5.0)
                  TAG_NAME=${GITHUB_REF#refs/tags/}
                  
                  # åˆ›å»ºæ‰“åŒ…æ–‡ä»¶å: mddplayer-v1.5.0-x86_64-pc-windows-msvc.zip
                  ARCHIVE_NAME="${{ env.PROJECT_NAME }}-${TAG_NAME}-${{ matrix.target }}.${{ matrix.archive_ext }}"
                  
                  echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
                  echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

            # 1.6 æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶
            - name: Archive executable
              shell: bash
              run: |
                  # ç¡®å®šå¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„
                  BINARY_PATH="target/${{ matrix.target }}/release/${{ matrix.bin_name }}"
                  
                  # åˆ›å»ºæ‰“åŒ…æ–‡ä»¶å¤¹
                  mkdir ${{ env.PROJECT_NAME }}
                  
                  # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶åˆ°æ‰“åŒ…æ–‡ä»¶å¤¹
                  cp $BINARY_PATH ${{ env.PROJECT_NAME }}/
                  
                  # æ‰“åŒ…
                  if [ "${{ matrix.archive_ext }}" = "zip" ]; then
                      zip -r ${{ steps.archive_vars.outputs.archive_name }} ${{ env.PROJECT_NAME }}
                  else
                      tar -czf ${{ steps.archive_vars.outputs.archive_name }} ${{ env.PROJECT_NAME }}
                  fi
                  
            # 1.7 ä¸Šä¼ æ‰“åŒ…æ–‡ä»¶ä½œä¸º Workflow Artifacts
            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.archive_vars.outputs.archive_name }}
                  path: ${{ steps.archive_vars.outputs.archive_name }}
                  # ä»…ä¿ç•™åœ¨ä¸Šä¼  Release æ­¥éª¤ä¸­éœ€è¦çš„æ–‡ä»¶

    # ----------------------------------------
    # 2. å‘å¸ƒä½œä¸š (ä¾èµ–äºæ„å»ºä½œä¸š)
    # ----------------------------------------
    create_release:
        name: Create GitHub Release
        runs-on: ubuntu-latest
        needs: [build_release] # ç¡®ä¿æ‰€æœ‰æ„å»ºéƒ½å·²å®Œæˆ
        
        steps:
            # 2.1 æ£€å‡ºä»£ç  (ç”¨äºè·å– tag)
            - uses: actions/checkout@v4
            
            # 2.2 ä¸‹è½½æ‰€æœ‰æ„å»ºä½œä¸šç”Ÿæˆçš„ Artifacts
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts
                  
            # 2.3 åˆ›å»º GitHub Release (è¿™å°†åˆ›å»ºè‰ç¨¿ Release)
            - name: Create Release
              id: create_release
              uses: softprops/action-gh-release@v2
              with:
                  # Release åç§°ä½¿ç”¨ Tag åç§°
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  # è‡ªåŠ¨ç”Ÿæˆ Release Note
                  generate_release_notes: true
                  # ä¸Šä¼  Artifacts æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶ä½œä¸ºé™„ä»¶
                  files: artifacts/*/*
              env:
                  # ä½¿ç”¨ GITHUB_TOKEN è¿›è¡Œè®¤è¯
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}